#!/usr/bin/make -f
# export DH_VERBOSE = 1

export ROOT = debian/tmp
export CHART_FOLDER = $(ROOT)/usr/lib/helm

%:
	dh $@

override_dh_auto_build:
	# Move the extracted helm chart files to the top level build directory.
	# Remove the helm-charts-certmanager Makefile first so it doesn't overwrite
	# our Makefile.
	rm helm-charts-certmanager/Makefile
	mv helm-charts-certmanager/* .
	# Apply the daemonset tolerations patch.
	patch -p1 < 0001-Patch-for-acmesolver.patch
	# Host a server for the helm charts.
	chartmuseum --debug --port=8879 --context-path='/charts' --storage="local" \
		--storage-local-rootdir="." &
	sleep 2
	helm repo add local http://localhost:8879/charts
	# Copy CRD yaml files to templates.
	cp deploy/crds/*.yaml deploy/charts/cert-manager/templates/
	# Set up chart build files.
	cp Makefile deploy/charts
	# In Cert-manager release-0.15, 'helm lint' fails
	# on templates/BUILD.bazel (with invalid file extension).
	# Remove the problem file.
	rm deploy/charts/cert-manager/templates/BUILD.bazel
	# Create the TGZ file.
	cd deploy/charts && make cert-manager
	# Terminate the helm chart server.
	pkill chartmuseum

override_dh_auto_install:
	# Install the app tar file.
	install -d -m 755 $(CHART_FOLDER)
	install -p -D -m 755 deploy/charts/*.tgz $(CHART_FOLDER)

override_dh_auto_test:
